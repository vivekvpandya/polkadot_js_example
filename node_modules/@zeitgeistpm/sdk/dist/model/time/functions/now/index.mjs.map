{"version":3,"file":"index.mjs","sources":["../../../../../src/model/time/functions/now/index.ts"],"sourcesContent":["import { ChainTime } from '@zeitgeistpm/utility/dist/time'\nimport { Observable } from 'rxjs'\nimport { RpcContext } from '../../../../context'\nimport { MetadataStorage } from '../../../../meta'\nimport { BlockNumber } from '../../../../primitives/blocknumber'\n\n/**\n * Get current chain time.\n *\n * @param ctx RpcContext\n * @returns Promise<ChainTime>\n */\nexport const now = async <MS extends MetadataStorage>(\n  ctx: RpcContext<MS>,\n): Promise<ChainTime> => {\n  const [now, head] = await Promise.all([\n    ctx.api.query.timestamp.now().then(now => now.toNumber()),\n    ctx.api.rpc.chain.getHeader(),\n  ])\n\n  const block = head.number.toNumber() as BlockNumber\n  const period = ctx.api.consts.timestamp.minimumPeriod.toNumber() * 2\n\n  return {\n    now,\n    block,\n    period,\n  }\n}\n\n/**\n * Stream the current chain time pr block.\n *\n * @param ctx RpcContext\n * @returns Observable<ChainTime>\n */\nexport const now$ = <MS extends MetadataStorage>(\n  ctx: RpcContext<MS>,\n): Observable<ChainTime> =>\n  new Observable(sub => {\n    now(ctx).then(time => sub.next(time))\n\n    const period = ctx.api.consts.timestamp.minimumPeriod.toNumber() * 2\n    const unsub = ctx.api.rpc.chain.subscribeFinalizedHeads(async head => {\n      const now = await ctx.api.query.timestamp.now().then(now => now.toNumber())\n      const block = head.number.toNumber() as BlockNumber\n      sub.next({\n        now,\n        block,\n        period,\n      })\n    })\n\n    return () => {\n      unsub.then(unsub => unsub())\n      sub.unsubscribe()\n    }\n  })\n"],"names":[],"mappings":";;AAMA;;;;;AAKG;MACU,GAAG,GAAG,OACjB,GAAmB,KACG;IACtB,MAAM,CAAC,GAAG,EAAE,IAAI,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;QACpC,GAAG,CAAC,GAAG,CAAC,KAAK,CAAC,SAAS,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,GAAG,IAAI,GAAG,CAAC,QAAQ,EAAE,CAAC;QACzD,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,KAAK,CAAC,SAAS,EAAE;AAC9B,KAAA,CAAC,CAAA;IAEF,MAAM,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,QAAQ,EAAiB,CAAA;AACnD,IAAA,MAAM,MAAM,GAAG,GAAG,CAAC,GAAG,CAAC,MAAM,CAAC,SAAS,CAAC,aAAa,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAA;IAEpE,OAAO;QACL,GAAG;QACH,KAAK;QACL,MAAM;KACP,CAAA;AACH,EAAC;AAED;;;;;AAKG;AACI,MAAM,IAAI,GAAG,CAClB,GAAmB,KAEnB,IAAI,UAAU,CAAC,GAAG,IAAG;AACnB,IAAA,GAAG,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,IAAI,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAA;AAErC,IAAA,MAAM,MAAM,GAAG,GAAG,CAAC,GAAG,CAAC,MAAM,CAAC,SAAS,CAAC,aAAa,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAA;AACpE,IAAA,MAAM,KAAK,GAAG,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,KAAK,CAAC,uBAAuB,CAAC,OAAM,IAAI,KAAG;QACnE,MAAM,GAAG,GAAG,MAAM,GAAG,CAAC,GAAG,CAAC,KAAK,CAAC,SAAS,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,GAAG,IAAI,GAAG,CAAC,QAAQ,EAAE,CAAC,CAAA;QAC3E,MAAM,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,QAAQ,EAAiB,CAAA;QACnD,GAAG,CAAC,IAAI,CAAC;YACP,GAAG;YACH,KAAK;YACL,MAAM;AACP,SAAA,CAAC,CAAA;AACJ,KAAC,CAAC,CAAA;AAEF,IAAA,OAAO,MAAK;QACV,KAAK,CAAC,IAAI,CAAC,KAAK,IAAI,KAAK,EAAE,CAAC,CAAA;QAC5B,GAAG,CAAC,WAAW,EAAE,CAAA;AACnB,KAAC,CAAA;AACH,CAAC;;;;"}